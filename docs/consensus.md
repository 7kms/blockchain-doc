# 共识算法

区块链本质上是一个分布式网络架构, 存在于区块链中的的所有节点都是一个独立的个体. 这些独立的个体如何验证区块链中数据的合法性, 则需要一种共识机制, 使得每一个节点能够识别并同步合法的区块, 共同维护安全公正的区块链网络.

不同的区块链(公有链: 如`BTC`, `ETH`, `BSC`, `TRON`, `EOS`等; 联盟链: `Hyperledger Fabric`)会采取不同的共识算法, 以满足各自的使用场景. 本节将介绍当前使用较为广泛的共识算法.

btc,eth,eos,tron,bsc,hyperleder fabric

## PoW (Proof Of Work)

> 工作量证明(这也是最简单, 最原始的区块链共识算法). 概括来说就是打包一个区块需要付出一定的工作量, 旷工需要证明他进行了辛苦的工作且完成了一个合法的区块打包.

### 基本原理

1. 挖矿机制

   旷工需要将一段时间内的 transaction 合并到一个区块中, 并计算该区块的 hash 值, 通过调整区块的 nonce 属性, 使得其 hash 值满足特定的要求(如: 以 n 个 0 开头), 旷工寻找到合适的 nonce 值需要不断的重复试错(运算量较大), 而验证这个 nonce 值相对容易(只需要带入计算一次即可). 当旷工(minter) 成功打包一个区块之后, 会将新的区块广播到区块链网络中, 其他旷工收到广播后会对其进行验证, 通过之后进行区块同步.

2. 奖励机制

   不同的公链奖励机制有所不同. 不过当前 `PoW` 公链的奖励体系里面都包含一项固定奖励, 任何旷工打包区块后固定奖励部分是相同的, 如`BTC`链每产生一个区块奖励 12.5 个 `BTC`, 如 `ETH(layer1)`链上每产生一个区块奖励 2 个 `ETH`.

### 特点

1. 使用者: BTC, ETH(layer1)等.
2. 优点: 算法简单, 应用广泛.
3. 缺点: 效率低, 速度慢, 需要消耗大量算力造成对环境的不友好(按照 ETH 官网的说法, ETH(layer1)全球节点的用电能耗`73.2 TWh`(相当于奥地利的总用电能耗)).

## PoS (Proof Of Stake)

> 权益证明. 概括来说就是一个根据持有数字货币数量和时间来分配相应利息的制度, 类似在银行存款, 银行会支付给你利息.

### 基本原理

1. 挖矿机制

   用户需要`质押一定量的代币`来成为区块链网络中的验证者, 即 `validator`(可以类比 `PoW` 机制中的旷工). `validator` 有 2 个职责, 当被选中创建区块时进行`区块创建`, 其余时候进行`区块验证`, 无论是作为创建者还是验证者都会得到相应的代币奖励. 由于 `validator` 是随机选取为创建者(质押的代币越多, 质押的时间越长, 会有更大的概率被选中), 是属于被动接受命令, 不需要主动竞争记账权, 所以不需要强大的算力.

2. 奖励机制

   PoS 的奖励机制是和`validator`质押代币的数量挂钩的, 当一个新的区块产生时奖励并不会包含固定奖励, 不同的`validator`由于质押不同, 得到的奖励是不同的. 如某个`validator`持有的代币数量是`100个`, 持有的时间周期是`10天`, 如果质押的年化收益率(APR)是`5%`, 则他得到的奖励是`100 * 10/365 * 0.05`. 获得奖励之后, 其持有的时间周期被重置为`0`. 这样的奖励模式就相当于在银行存款, 得到的奖励就是利息(质押的代币数量越多, 时间越长, 自然收益越高).

当前 defi 领域十分火热的`质押挖矿`, 实际上是将散户的代币集中转移给一个`validator`, `validator`在持有了大量代币之后更容易获得创建区块的机会, 同时`validator`获得的收益也按比例分配给投资者. ETH(layer2)已经采用`PoS`的共识机制, 需要质押 32 个 ETH 可以成为一个`validator`.

### 特点

1. 使用者: ETH(layer2), Avalanche(AVAX).
2. 优点: 硬件要求低, 且节能(不用竞争记账权, 计算量小), 更加去中心化(节点更多).
3. 缺点: 相较 PoW 实现更复杂.

PoS 算法由于同时兼顾了高 TPS, 高能效, 且不失去中心化等特性, 所以受到更多公有链的青睐, 大多数公有链都直接使用了`PoS`或在`PoS`的基础上进行变种(如: [avalanche 链](https://www.avax.network/)基于 PoS 实现了自己的[avalanche 共识协议](https://docs.avax.network/#avalanche-consensus-protocol)). 以`PoS`为基础的变种其实是比较多的

## DPoS (Delegated Proof Of Stake)

> 授权权益证明, 又称委托人机制. 概括来说`DPoS`是建立在`PoS`的基础之上, 再次选出一定数量(如 21 个, 101 个等)的超级节点来进行区块的打包和验证. 普通的节点只有选举权, 没有实际的记账权和验证权. 超级节点以一定的方式进行选举, 普通节点是有机会成为超级节点的. 由于超级节点的数量少, `DPoS`算法会更快, 同时也比较中心化.

`DPoS`实现了一个真正公平的选举系统

### 基本原理

1. 挖矿机制
2. 奖励机制

### 特点

1. 使用者: EOS, BC(币安链), TRON(波场)等
2. 优点: 高能效, 共识更快, 持币越多的节点越有决定权
3. 缺点: 由于决定权在有限的节点手中, 需要更多的审查机制避免一些恶意节点. 参与投票的节点越少(选举权也落在了有限的节点中), 越有可能造成中心化.

## PoSA (Proof of Staked Authority)

>

### 基本原理

1. 挖矿机制

2. 奖励机制

   上述奖励机制只能代表一般情况, 不同的区块链由于自己的业务限定, 会有自己特定的奖励机制(甚至没有奖励). 比如`币安智能链(BSC)`采用`PoSA`共识算法, 但是为了抑制通货膨胀, 创建新区块时`validator`只能得到`transaction fee`,不会凭空产生新的代币.

### 特点

## PoA (Proof-of-Authority)

> 权威证明. 需要通过链下的筛选和审核才能成为`validator`

## BFT (Byzantime Fault Tolerance)
